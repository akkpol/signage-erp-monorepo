// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum MaterialType {
  VINYL
  SUBSTRATE
  LAMINATE
  INK
  OTHER
}

enum UnitType {
  SQM
  LINEAR_METER
  PIECE
}

enum TransactionType {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
}

// Multi-tenant core (Hidden complexity for MVP)
model Organization {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique // e.g., "MYSHOP"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customers  Customer[]
  products   Product[]
  materials  Material[]
  orders     Order[]
  quotations Quotation[]
  invoices   Invoice[]
  payments   Payment[]
}

// Customers
model Customer {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  name    String
  phone   String?
  lineId  String?
  address String?
  taxId   String?

  orders     Order[]
  quotations Quotation[]
  invoices   Invoice[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

// Products (Base templates like "Vinyl Sticker", "Lightbox")
model Product {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  name        String
  description String?
  imageUrl    String?
  basePrice   Float   @default(0) // Starting price

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Materials (Raw materials for calculation)
model Material {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  name         String // e.g. "Vinyl Glossy", "Acrylic 3mm"
  type         MaterialType @default(OTHER)
  unit         String // "sqm", "sheet", "meter" - Consider migrating to UnitType enum later
  costPrice    Float // Cost per unit
  sellingPrice Float // Selling price per unit (for calculator)

  wasteFactor Float @default(1.15) // 15% waste
  inStock     Float @default(0)

  pricingTiers PricingTier[]
  transactions StockTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PricingTier {
  id         String   @id @default(uuid())
  materialId String
  material   Material @relation(fields: [materialId], references: [id])

  minQuantity     Float
  discountPercent Float // e.g. 10 for 10%

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DocumentStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  VOID
}

// Orders
model Order {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  orderNumber String // Human readable: JOB-2402001 (Generated)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  status String @default("NEW") // NEW, PENDING_APPROVAL, DESIGNING, PRODUCTION, INSTALLATION, DELIVERED, DONE, CANCELLED

  totalAmount Float @default(0)
  vatAmount   Float @default(0)
  grandTotal  Float @default(0)

  items    OrderItem[]
  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Order Items (Individual line items)
model OrderItem {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  name     String // Snapshot of product name
  width    Float? // Width in meters
  height   Float? // Height in meters
  quantity Int    @default(1)

  unitPrice  Float
  totalPrice Float

  details String? // Store selected material, finishing options, etc. (JSON stringified)

  designFiles DesignFile[]
}

// Quotations
model Quotation {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  quotationNumber String // Human readable: QT-2402001
  status         DocumentStatus @default(DRAFT)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  totalAmount Float @default(0)
  vatAmount   Float @default(0)
  grandTotal  Float @default(0)

  items QuotationItem[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime?
}

model QuotationItem {
  id          String    @id @default(uuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  name     String
  width    Float?
  height   Float?
  quantity Int    @default(1)

  unitPrice  Float
  totalPrice Float

  details String?
}

// Invoices
model Invoice {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  invoiceNumber String // Human readable: INV-2402001
  status        DocumentStatus @default(DRAFT)

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  totalAmount Float @default(0)
  vatAmount   Float @default(0)
  grandTotal  Float @default(0)
  amountPaid  Float @default(0)

  payments Payment[]

  dueDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// Payments
model Payment {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  amount        Float
  paymentMethod String // CASH, TRANSFER, CREDIT_CARD
  reference     String? // Bank ref or slip info
  paymentDate   DateTime @default(now())

  createdAt DateTime @default(now())
}

// Design Files
model DesignFile {
  id             String   @id @default(uuid())
  organizationId String
  // organization   Organization @relation(fields: [organizationId], references: [id])

  orderItemId    String
  orderItem      OrderItem @relation(fields: [orderItemId], references: [id])

  fileName       String
  externalLink   String?
  version        Int      @default(1)
  status         String   @default("draft")

  uploadedById   String
  uploadedBy     User     @relation(fields: [uploadedById], references: [id])

  notes          String?
  tags           String[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model User {
  id    String @id @default(uuid())
  name  String
  email String @unique

  designFiles DesignFile[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Stock Management
model StockTransaction {
  id          String   @id @default(uuid())
  materialId  String
  material    Material @relation(fields: [materialId], references: [id])

  type      TransactionType
  quantity  Float
  reference String? // PO-123, JOB-456
  notes     String?

  createdAt DateTime @default(now())
}
